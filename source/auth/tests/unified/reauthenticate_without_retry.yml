---
description: reauthenticate_without_retry
schemaVersion: '1.12'
runOnRequirements:
- minServerVersion: '6.3'
  auth: true
createEntities:
- client:
    id: client0
    uriOptions:
      retryReads: false
      retryWrites: false
    observeEvents:
    - commandStartedEvent
    - commandSucceededEvent
    - commandFailedEvent
- database:
    id: database0
    client: client0
    databaseName: db
- collection:
    id: collection0
    database: database0
    collectionName: collName
initialData:
- collectionName: collName
  databaseName: db
  documents:
  - _id: 1
  - _id: 2
  - _id: 3
tests:
- description: Find command should reauthenticate when receive ReauthenticationRequired
    error code and retryReads=false
  operations:
  - name: failPoint
    object: testRunner
    arguments:
      client: client0
      failPoint:
        configureFailPoint: failCommand
        mode:
          times: 1
        data:
          failCommands:
          - find
          errorCode: 391
  - name: find
    arguments:
      filter: {}
    object: collection0
    expectResult: []
  expectEvents:
  - client: client0
    events:
    - commandStartedEvent:
        command:
          find: collName
          filter: {}
    - commandFailedEvent:
        commandName: find
    - commandStartedEvent:
        command:
          find: collName
          filter: {}
    - commandSucceededEvent:
        commandName: find
- description: Insert command should reauthenticate when receive ReauthenticationRequired
    error code and retryWrites=false
  operations:
  - name: failPoint
    object: testRunner
    arguments:
      client: client0
      failPoint:
        configureFailPoint: failCommand
        mode:
          times: 1
        data:
          failCommands:
          - insert
          errorCode: 391
  - name: insertOne
    object: collection0
    arguments:
      document:
        _id: 4
        x: 1
  expectEvents:
  - client: client0
    events:
    - commandStartedEvent:
        command:
          insert: collName
          documents:
          - _id: 4
            x: 1
    - commandFailedEvent:
        commandName: insert
    - commandStartedEvent:
        command:
          insert: collName
          documents:
          - _id: 4
            x: 1
    - commandSucceededEvent:
        commandName: insert
- description: GetMore command should reauthenticate when receive ReauthenticationRequired
    error code and retryWrites=false
  operations:
  - name: failPoint
    object: testRunner
    arguments:
      client: client0
      failPoint:
        configureFailPoint: failCommand
        mode:
          times: 1
        data:
          failCommands:
          - getMore
          errorCode: 391
  - name: find
    object: collection0
    arguments:
      filter: {}
      sort:
        _id: 1
      batchSize: 2
  expectEvents:
  - client: client0
    events:
    - commandStartedEvent:
        command:
          find: collName
          filter: {}
    - commandSucceededEvent:
        commandName: find
    - commandStartedEvent:
        command:
          getMore:
            "$$type":
            - int
            - long
          collection: collName
          batchSize: 2
    - commandFailedEvent:
        commandName: getMore
    - commandStartedEvent:
        command:
          getMore:
            "$$type":
            - int
            - long
          collection: collName
          batchSize: 2
    - commandSucceededEvent:
        commandName: getMore
